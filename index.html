<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Gallery</title>
    <style>
        /* CSS 样式 (保留原有样式，并添加了分页错误消息样式) */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }

        .media-container {
            position: relative;
            overflow: hidden;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .media-container img,
        .media-container video {
            width: 100%;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }

        .media-container:hover img,
        .media-container:hover video {
            transform: scale(1.1);
        }

        .thumbnail {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #eee;
            filter: blur(10px);
            transition: filter 0.5s ease;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .thumbnail.loaded {
            filter: blur(0);
        }

        #fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            overflow: auto;
            /* 允许滚动 */
        }

        #fullscreen-container[aria-modal="true"] {
            display: flex;
        }

        #fullscreen-image,
        #fullscreen-video {
            max-width: 90%;
            max-height: 90%;
            display: block;
        }

        #fullscreen-close {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        video::-webkit-media-controls {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
        }

        #pagination {
            margin-top: 20px;
            text-align: center;
        }

        #pagination input {
            width: 50px;
            text-align: center;
        }

        #pagination button {
            padding: 5px 10px;
            cursor: pointer;
        }

        /* 新增的分页错误消息样式 */
        #pagination .error-message {
            color: red;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Media Gallery</h1>
        <div id="grid">
            <!-- Media items will be loaded here -->
        </div>

        <div id="pagination">
            <button id="prevPageBtn">上一页</button>
            <label>
                页码:
                <input type="number" id="pageInput" value="1">
            </label>
            /
            <span id="totalPageSpan">0</span>
            <button id="goToPageBtn">跳转</button>
            <button id="nextPageBtn">下一页</button>
            <!-- 分页错误消息将显示在这里 -->
        </div>
    </div>

    <div id="fullscreen-container" role="dialog" aria-modal="true">
        <span id="fullscreen-close">&times;</span>
        <img id="fullscreen-image" src="" alt="">
        <video id="fullscreen-video" controls loop></video>
    </div>

    <script>
        // JavaScript 代码 (修改后的代码)
        const grid = document.getElementById('grid');
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const fullscreenImage = document.getElementById('fullscreen-image');
        const fullscreenVideo = document.getElementById('fullscreen-video');
        const fullscreenClose = document.getElementById('fullscreen-close');
        const pageInput = document.getElementById('pageInput');
        const totalPageSpan = document.getElementById('totalPageSpan');
        const prevPageBtn = document.getElementById('prevPageBtn');
        const goToPageBtn = document.getElementById('goToPageBtn');
        const nextPageBtn = document.getElementById('nextPageBtn');

        let currentPage = 1;
        let totalPages = 0;
        let totalItems = 0; // 总项目数
        const blobUrls = []; // 用于存储 blob url
        const allVideos = []; // 用于存储所有 video 元素

        // API 端点和每页显示的媒体数量 (请根据你的实际情况修改)
        const API_ENDPOINT = '/api/media'; // 你的 API 端点
        const ITEMS_PER_PAGE = 20; // 每页显示的媒体数量


        // 辅助函数：将 URL 转换为 Blob 对象
        async function urlToBlob(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            return blob;
        }

        // 加载视频
        async function loadVideo(container, url) {
            const video = document.createElement('video');
            video.controls = true;
            video.loop = true;
            video.muted = true; // 默认静音
            video.playsInline = true; // 确保在 iOS 设备上内联播放
            allVideos.push(video);

            video.addEventListener('loadedmetadata', () => {
                container.querySelector('.thumbnail').classList.add('loaded');
            });

            video.addEventListener('error', (e) => {
                console.error('Fetch video failed, fallback to direct URL', e);
                video.src = url;
            });

            try {
                const blob = await urlToBlob(url);
                const blobUrl = URL.createObjectURL(blob);
                video.src = blobUrl;
                blobUrls.push(blobUrl);
                container.querySelector('.thumbnail').classList.add('loaded');

                video.addEventListener('error', (e) => {
                    console.error('Fetch video failed, fallback to direct URL', e);
                    video.src = url;
                });

            } catch (e) {
                console.error('Fetch video failed, fallback to direct URL', e);
                video.src = url;
            }

            container.innerHTML = '';
            container.appendChild(video);


            video.addEventListener('keydown', (event) => {
                if (event.key === ' ') {
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                }
            });

            video.addEventListener('ended', () => {
                video.play();
            });
        }

        // 加载图片
        async function loadImage(container, url, alt = '', thumbnail) {
            const img = document.createElement('img');
            img.alt = alt;

            img.onload = () => {
                container.querySelector('.thumbnail').classList.add('loaded');
            };

            img.onerror = () => {
                console.error('Fetch image failed, fallback to direct URL', e);
                img.src = url;
            };

            try {
                const blob = await urlToBlob(url);
                const blobUrl = URL.createObjectURL(blob);
                img.src = blobUrl;
                blobUrls.push(blobUrl);
                container.querySelector('.thumbnail').classList.add('loaded');

                img.onload = () => { // Add onload function after the blobUrl is set.
                    container.querySelector('.thumbnail').classList.add('loaded');
                };

                img.onerror = () => {
                    console.error('Fetch image failed, fallback to direct URL', e);
                    img.src = url;
                };


            } catch (e) {
                console.error('Fetch image failed, fallback to direct URL', e);
                img.src = url;
            }

            container.innerHTML = '';
            container.appendChild(img);
        }

        // Intersection Observer 用于懒加载
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const container = entry.target;
                    const type = container.dataset.type;
                    const src = container.dataset.src;
                    const alt = container.dataset.alt;

                    if (type === 'video') {
                        loadVideo(container, src);
                    } else {
                        loadImage(container, src, alt, container.querySelector('.thumbnail'));
                    }

                    observer.unobserve(container);
                }
            });
        }, {
            rootMargin: '200px'
        });

        // 渲染页面
        async function renderPage(page) {
            // 清理 Blob URLs 和视频
            blobUrls.forEach(url => URL.revokeObjectURL(url));
            blobUrls.length = 0;
            grid.innerHTML = '';
            allVideos.length = 0;

            // 构建 API URL
            const apiUrl = `${API_ENDPOINT}?page=${page}&limit=${ITEMS_PER_PAGE}`;

            try {
                // 使用 fetch 获取数据
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json(); // 假设服务器返回 JSON 格式的数据

                // 检查返回的数据是否是数组
                if (!Array.isArray(data)) {
                    console.error('API returned invalid data. Expected an array.');
                    return; // 或者显示错误消息
                }

                // 渲染媒体列表
                data.forEach(item => {
                    const container = document.createElement('div');
                    container.className = 'media-container';
                    container.dataset.src = item.src;
                    container.dataset.type = item.type;
                    container.dataset.alt = item.alt || ''; // 添加 alt 属性

                    const thumbnail = document.createElement('div');
                    thumbnail.className = 'thumbnail';
                    container.appendChild(thumbnail);

                    if (item.type === 'video') {
                        //loadVideo(container, item.src); // 懒加载，先不加载视频
                    } else {
                        loadImage(container, item.src, item.alt, thumbnail); // 立即加载图片缩略图
                    }

                    grid.appendChild(container);
                });


                // 更新当前页码和总页数
                currentPage = page;

                // 假设服务器也返回了 totalItems 字段，表示总共有多少个媒体项
                //totalItems = data.totalItems; // 假设服务器返回了总项目数
                //totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);

                // 如果服务器没有返回总项目数，你需要自己计算
                // 注意：这需要在第一次加载时获取完整的媒体列表长度。
                if (totalPages === 0) {
                    const tempResponse = await fetch(`${API_ENDPOINT}?page=1&limit=999999`); // 获取所有数据以计算总页数
                    const tempData = await tempResponse.json();
                    totalItems = tempData.length;
                    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                }


                pageInput.value = currentPage;
                totalPageSpan.textContent = totalPages;

                // 触发 Intersection Observer
                observer.disconnect(); // 先断开之前的观察者
                const mediaContainers = document.querySelectorAll('.media-container');
                mediaContainers.forEach(media => observer.observe(media));

            } catch (error) {
                console.error('Error fetching media:', error);
                // 在页面上显示错误消息
                grid.textContent = 'Failed to load media. Please try again later.';
            }
        }

        // 初始化页面时加载第一页
        document.addEventListener('DOMContentLoaded', () => {
            renderPage(1); // 加载第一页
        });

        // 全屏显示
        function showFullscreen(element) {
            if (element.tagName === 'IMG') {
                fullscreenImage.src = element.src;
                fullscreenImage.style.display = 'block';
                fullscreenVideo.style.display = 'none';
            } else if (element.tagName === 'VIDEO') {
                fullscreenVideo.src = element.src;
                fullscreenVideo.style.display = 'block';
                fullscreenImage.style.display = 'none';
                fullscreenVideo.play();
            }
            fullscreenContainer.setAttribute('aria-modal', 'true');
            fullscreenContainer.focus(); // 设置焦点
        }

        // 关闭全屏
        function closeFullscreen() {
            fullscreenContainer.setAttribute('aria-modal', 'false');
            fullscreenImage.src = '';
            fullscreenVideo.pause();
            fullscreenVideo.src = '';
        }

        // 事件监听器
        grid.addEventListener('click', (event) => {
            const target = event.target;
            if (target.tagName === 'IMG' || target.tagName === 'VIDEO') {
                showFullscreen(target);
            }
        });

        fullscreenClose.addEventListener('click', closeFullscreen);

        fullscreenContainer.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                closeFullscreen();
            }
        });

        window.addEventListener('beforeunload', () => {
            blobUrls.forEach(url => URL.revokeObjectURL(url));
        });

        // 分页按钮事件
        prevPageBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                renderPage(currentPage - 1);
            }
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                renderPage(currentPage + 1);
            }
        });

        goToPageBtn.addEventListener('click', () => {
            const page = parseInt(pageInput.value, 10);
            if (!isNaN(page) && page >= 1 && page <= totalPages) {
                renderPage(page);
            } else {
                const errorMsg = document.createElement('p');
                errorMsg.textContent = "请输入有效的页码 (1-" + totalPages + ")";
                errorMsg.style.color = 'red';
                errorMsg.style.marginTop = '5px';
                const paginationDiv = document.getElementById('pagination');
                const existingError = paginationDiv.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }
                errorMsg.classList.add('error-message');
                paginationDiv.appendChild(errorMsg);
                pageInput.value = '';
            }
        });
    </script>
</body>

      </html>
